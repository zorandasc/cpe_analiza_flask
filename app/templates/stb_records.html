{% extends "base.html" %} {% block title %}CPE-ANALIZA{% endblock %} {% block
styles %} {{ super() }}
<style>
  .title {
    font-weight: 700;
    letter-spacing: 1px;
    position: relative;
    padding: 0;
    margin: 0;
    text-align: center;
    padding-bottom: 5px;
  }

  .title:before {
    width: 28px;
    height: 6px;
    display: block;
    content: "";
    position: absolute;
    bottom: 3px;
    left: 50%;
    margin-left: -14px;
    background: linear-gradient(to right, #be93c5, #7bc6cc);
  }

  .title:after {
    width: 400px;
    height: 2px;
    display: block;
    content: "";
    position: relative;
    margin-top: 15px;
    left: 50%;
    margin-left: -200px;
    background: linear-gradient(to right, #be93c5, #7bc6cc);
  }
  .info {
    display: block;
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 4px;
    line-height: 3em;
    padding-left: 0.25em;
    color: rgba(0, 0, 0, 0.4);
  }

  .btn-custom-save {
    background: linear-gradient(to right, #be93c5, #7bc6cc);
    color: whitesmoke;
    box-shadow: 1px 1px 2px rgb(0, 0, 0);
  }

  .btn-custom-stb-add {
    background: linear-gradient(to right, #be93c5, #7bc6cc);
    color: rgb(0, 0, 0);
    box-shadow: 1px 1px 2px rgb(0, 0, 0);
    margin-bottom: 1rem;
    /*text-shadow: 1px 1px #f0ebeb;*/
    font-weight: 600;
  }

    .btn-custom-history {
    background: linear-gradient(to right, #ada996, #f2f2f2, #dbdbdb, #eaeaea);
    color: rgb(47, 46, 46);
    box-shadow: 1px 1px 2px rgb(0, 0, 0);
    margin-bottom: 1rem;
  }

  .custom-modal-header {
    background: linear-gradient(to right, #7bc6cc, #be93c5);
  }

  .input-cpe-count {
    /* Set a specific maximum width for the small number fields */
    max-width: 80px;
    /* Ensures they don't stretch beyond this point */
    margin: 0 auto;
  }
  .cpe-label-wrap {
    white-space: normal;
    text-align: center;
    height: 38px; /* Bootstrap input height */
    line-height: 1.2;
  }

  .d-flex.mb-2 {
    display: flex;
    align-items: center; /* Vertically centers label and input in the row */
    margin-bottom: 10px;
  }

  /* The Label Wrapper */
  .cpe-label-wrap {
    flex: 0 0 150px; /* Does not grow, does not shrink, stays 150px wide */
    max-width: 150px; /* Ensures it doesn't expand */
    margin-right: 15px; /* Space between label and input */
    word-wrap: break-word; /* Prevents long text from breaking layout */
  }

  /* The Input Field */
  .input-cpe-count {
    flex: 1; /* Allows input to fill the remaining horizontal space */
    max-width: 200px; /* Optional: Prevents inputs from getting too wide */
  }

  .total-iptv {
    max-width: 130px;
  }
</style>
{% endblock %} {% block content%}
<div class="py-2">
  <h2 class="mb-4 text-center title">Stanje STB uređaja i IPTV korisnika</h2>
  <div class="d-flex justify-content-between">
  {% if iptv_required() %}
  <button
    type="button"
    title="Ažuritajte posljednje stanje STB opreme"
    data-bs-toggle="modal"
    data-bs-target="#stbEditModal"
    class="btn btn-custom-stb-add"
    id="target-section"
  >
    + Dodaj / Izmjeni Sedmični Unos
  </button>
 {% endif %}
  
  <!--EVERY RECORD SHOULD HAVE SAME last_updated-->
  <span class="info">
    Posljedne ažurirano:{% if records[0] %} {{
    records[0]['last_updated'].strftime('%d-%m-%Y%H:%M') }} {% endif %}
  </span>
  <a
              href="{{ url_for('stb_inventory.stb_records_history') }}"
              class="btn btn-sm btn-custom-history"
              title="Istorija promjena"
              >Istorija promijena
                <span class="text-white fw-bold fs-6">
                  <svg fill="#000000" height="1em" width="1em" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 484 484" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <g> <g> <path d="M410.413,70.88C364.706,25.172,303.934,0,239.293,0c-47.493,0-93.076,13.591-132.383,39.378l-2.909-2.985 C93.086,25.194,77.521,20.808,62.366,24.662c-15.155,3.854-26.735,15.14-30.975,30.192L4.369,150.781 c-4.239,15.05-0.255,30.72,10.658,41.917c8.308,8.524,19.31,13.101,30.775,13.101c3.595,0,7.236-0.45,10.854-1.37l96.591-24.548 c15.156-3.852,26.736-15.137,30.978-30.189c3.54-12.562,1.331-25.547-5.836-36.012C197.287,104.713,218.107,100,239.293,100 c78.299,0,142,63.701,142,142s-63.701,142-142,142c-40.717,0-79.54-17.527-106.514-48.087 c-18.243-20.667-49.903-22.642-70.573-4.399c-10.013,8.838-15.985,21.046-16.816,34.376 c-0.831,13.329,3.579,26.185,12.417,36.198C103.753,454.144,169.903,484,239.293,484c64.641,0,125.414-25.172,171.121-70.88 c45.708-45.708,70.88-106.479,70.88-171.12S456.121,116.588,410.413,70.88z M164.975,144.269 c-2.28,8.092-8.506,14.159-16.654,16.23L51.73,185.046c-8.146,2.072-16.513-0.287-22.38-6.307 c-5.867-6.02-8.009-14.444-5.73-22.536l27.023-95.928c2.279-8.092,8.504-14.16,16.652-16.231 c8.15-2.071,16.516,0.286,22.383,6.307l33.072,33.933l32.604,33.454c0.003,0.003,0.006,0.005,0.009,0.008l3.883,3.984 C165.113,127.751,167.255,136.177,164.975,144.269z M396.271,398.978C354.341,440.908,298.592,464,239.293,464 c-63.656,0-124.34-27.39-166.492-75.147c-5.303-6.008-7.948-13.722-7.45-21.719s4.082-15.323,10.089-20.625 c5.695-5.026,12.777-7.494,19.835-7.494c8.313,0,16.589,3.427,22.51,10.133C148.553,384.007,192.841,404,239.293,404 c89.328,0,162-72.673,162-162s-72.673-162-162-162c-26.21,0-51.956,6.312-74.942,18.314l-11.509-11.809l-31.691-32.517 C156.439,31.715,197.037,20,239.293,20c59.299,0,115.048,23.092,156.978,65.022c41.931,41.93,65.022,97.679,65.022,156.978 S438.201,357.047,396.271,398.978z"></path> </g> </g> <g> <path d="M420.202,336.007c-1.397,0-2.817-0.294-4.17-0.916c-5.019-2.306-7.217-8.244-4.911-13.262 c11.395-24.793,17.172-51.315,17.172-78.829c0-35.76-10.031-70.57-29.01-100.666c-2.945-4.672-1.547-10.847,3.125-13.792 c4.672-2.948,10.846-1.547,13.793,3.125c20.994,33.294,32.092,71.793,32.092,111.334c0,30.417-6.392,59.749-18.999,87.18 C427.611,333.846,423.987,336.007,420.202,336.007z"></path> </g> <g> <path d="M375.291,107.724c-2.45,0-4.904-0.895-6.834-2.701c-13.866-12.987-29.525-23.772-46.542-32.057 c-4.966-2.418-7.031-8.403-4.614-13.369c2.417-4.965,8.403-7.031,13.368-4.614c18.817,9.162,36.131,21.086,51.46,35.442 c4.031,3.775,4.238,10.104,0.463,14.135C380.623,106.662,377.96,107.724,375.291,107.724z"></path> </g> </g> <g> <path d="M284.002,329c-8.014,0-15.548-3.121-21.214-8.787l-44.499-44.5c-5.675-5.675-8.784-13.202-8.776-21.228 c-0.007-0.161-0.011-0.322-0.011-0.485V151c0-16.542,13.458-30,30-30s30,13.458,30,30v91.073l35.714,35.713v0 c11.695,11.697,11.695,30.729,0,42.426C299.55,325.879,292.016,329,284.002,329z M229.502,253.729 c0.006,0.132,0.01,0.263,0.012,0.396c0.001,0.083,0,0.165,0,0.248c-0.035,2.726,1.001,5.283,2.918,7.199l44.499,44.5 c1.889,1.889,4.4,2.929,7.071,2.929s5.183-1.04,7.071-2.929c3.898-3.898,3.898-10.243,0-14.142l-38.643-38.642 c-1.875-1.875-2.929-4.419-2.929-7.071V151c0-5.514-4.486-10-10-10c-5.514,0-10,4.486-10,10V253.729z"></path> </g> </g> </g></svg>
                  </span>
                </a>
</div>
  <div class="table-responsive">
    <table class="table table-bordered table-striped shadow mb-4">
      <thead class="table-primary">
        <tr>
          <th>STB Uređaji</th>
          {% for week in weeks %}
          <th>{{ week.label}}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in records%}
        <tr class="{% if r.is_total %}table-success fw-bold{% endif %}">
          <td>{{r.label}}</td>
          {% for week in weeks%}
          <td>{{r['dates'][week.key]['quantity']}}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-end">
   {% if iptv_required() %}
  <button
    type="button"
    title="Ažuritajte posljednje stanje STB opreme"
    data-bs-toggle="modal"
    data-bs-target="#iptvEditModal"
    class="btn btn-custom-stb-add mt-4"
  >
    + Dodaj / Izmjeni Sedmični Unos
  </button>
   {% endif %}
  <span class="info">
    Posljednje ažurirano: {% if iptv_users[-1] %} {{
    iptv_users[-1]['updated_at'].strftime('%d-%m-%Y %H:%M') }} {% endif %}
  </span>
  </div>
  <table class="table table-bordered table-striped shadow">
    <thead class="table-primary">
      <tr>
        <th></th>
        {% for row in iptv_users %}
        <th>{{ row['week_end'].strftime('%d-%m-%Y') }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="fw-bold total-iptv">Ukupan broj IPTV korisnika</td>
        {% for row in iptv_users%}
        <td>{{row['total_users']}}</td>
        {% endfor %}
      </tr>
    </tbody>
  </table>
   <a
      class="btn btn-sm btn-outline-secondary mb-2"
      href="{{ url_for('stb_inventory.export_stb_records_excel')}}"
    >
      Export Excel
    </a>
</div>

<div class="modal fade" id="stbEditModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form
        method="POST"
        action="{{url_for('stb_inventory.update_stb_inventory')}}"
      >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header custom-modal-header">
          <h4 class="modal-title">
            Dodaj novo stanje za: {{ current_week_end }}
          </h4>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          {% for r in records %} {% if not r.is_total %}
          <div class="d-flex mb-2">
            <div class="cpe-label-wrap">{{r.label }}</div>
            <input
              class="form-control input-cpe-count"
              name="{{ r.id }}"
              type="number"
              value="{{ r['dates'][weeks[-1].key]['quantity']}}"
              min="0"
            />
          </div>
          {% endif %} {% endfor %}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-custom-save">
            <span class="text-white fw-bold fs-4">
              <svg
                fill="#ffffff"
                height="20px"
                width="20px"
                version="1.1"
                id="Layer_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 512 512"
                xml:space="preserve"
              >
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g
                  id="SVGRepo_tracerCarrier"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></g>
                <g id="SVGRepo_iconCarrier">
                  <g>
                    <g>
                      <g>
                        <path
                          d="M128,170.667h256c4.719,0,8.533-3.823,8.533-8.533V42.667c0-4.71-3.814-8.533-8.533-8.533 c-4.719,0-8.533,3.823-8.533,8.533V153.6H136.533V17.067h110.933c4.719,0,8.533-3.823,8.533-8.533S252.186,0,247.467,0H128 c-4.719,0-8.533,3.823-8.533,8.533v153.6C119.467,166.844,123.281,170.667,128,170.667z"
                        ></path>
                        <path
                          d="M384,494.933H42.667c-14.114,0-25.6-11.486-25.6-25.6V42.667c0-14.114,11.486-25.6,25.6-25.6h51.2 c4.719,0,8.533-3.823,8.533-8.533S98.586,0,93.867,0h-51.2C19.14,0,0,19.14,0,42.667v426.667C0,492.86,19.14,512,42.667,512H384 c4.719,0,8.533-3.823,8.533-8.533S388.719,494.933,384,494.933z"
                        ></path>
                        <path
                          d="M509.5,87.834L424.166,2.5c-1.596-1.604-3.763-2.5-6.033-2.5h-68.975c-4.719,0-8.533,3.823-8.533,8.533 c0,1.203,0.256,2.338,0.708,3.379v107.554h-51.2v-102.4h25.6c4.719,0,8.533-3.823,8.533-8.533S320.452,0,315.733,0H281.6 c-4.719,0-8.533,3.823-8.533,8.533V128c0,4.71,3.814,8.533,8.533,8.533h68.267c4.719,0,8.533-3.823,8.533-8.533V17.067h56.201 l80.333,80.333v371.934c0,14.114-11.486,25.6-25.6,25.6h-42.667V281.6c0-4.71-3.814-8.533-8.533-8.533H93.867 c-4.719,0-8.533,3.823-8.533,8.533v187.733c0,4.71,3.814,8.533,8.533,8.533c4.719,0,8.533-3.823,8.533-8.533v-179.2h307.2 v213.333c0,4.71,3.814,8.533,8.533,8.533h51.2C492.86,512,512,492.86,512,469.333V93.867C512,91.605,511.104,89.429,509.5,87.834 z"
                        ></path>
                        <path
                          d="M179.2,426.667h153.6c4.719,0,8.533-3.823,8.533-8.533s-3.814-8.533-8.533-8.533H179.2c-4.719,0-8.533,3.823-8.533,8.533 S174.481,426.667,179.2,426.667z"
                        ></path>
                        <path
                          d="M179.2,375.467h153.6c4.719,0,8.533-3.823,8.533-8.533s-3.814-8.533-8.533-8.533H179.2c-4.719,0-8.533,3.823-8.533,8.533 S174.481,375.467,179.2,375.467z"
                        ></path>
                      </g>
                    </g>
                  </g>
                </g>
              </svg>
            </span>
            Sačuvaj
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="iptvEditModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form
        method="POST"
        action="{{url_for('stb_inventory.update_iptv_users')}}"
      >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header custom-modal-header">
          <h4 class="modal-title">
            Dodaj novo stanje za: {{ current_week_end }}
          </h4>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="d-flex mb-2">
            <label>Broj IPTV korisnika:</label>
            <input
              class="form-control input-cpe-count"
              name="qty"
              type="number"
              value="{{ (iptv_users | last)['total_users'] if iptv_users else 0 }}"
              min="0"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-custom-save">
            <span class="text-white fw-bold fs-4">
              <svg
                fill="#ffffff"
                height="20px"
                width="20px"
                version="1.1"
                id="Layer_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 512 512"
                xml:space="preserve"
              >
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g
                  id="SVGRepo_tracerCarrier"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></g>
                <g id="SVGRepo_iconCarrier">
                  <g>
                    <g>
                      <g>
                        <path
                          d="M128,170.667h256c4.719,0,8.533-3.823,8.533-8.533V42.667c0-4.71-3.814-8.533-8.533-8.533 c-4.719,0-8.533,3.823-8.533,8.533V153.6H136.533V17.067h110.933c4.719,0,8.533-3.823,8.533-8.533S252.186,0,247.467,0H128 c-4.719,0-8.533,3.823-8.533,8.533v153.6C119.467,166.844,123.281,170.667,128,170.667z"
                        ></path>
                        <path
                          d="M384,494.933H42.667c-14.114,0-25.6-11.486-25.6-25.6V42.667c0-14.114,11.486-25.6,25.6-25.6h51.2 c4.719,0,8.533-3.823,8.533-8.533S98.586,0,93.867,0h-51.2C19.14,0,0,19.14,0,42.667v426.667C0,492.86,19.14,512,42.667,512H384 c4.719,0,8.533-3.823,8.533-8.533S388.719,494.933,384,494.933z"
                        ></path>
                        <path
                          d="M509.5,87.834L424.166,2.5c-1.596-1.604-3.763-2.5-6.033-2.5h-68.975c-4.719,0-8.533,3.823-8.533,8.533 c0,1.203,0.256,2.338,0.708,3.379v107.554h-51.2v-102.4h25.6c4.719,0,8.533-3.823,8.533-8.533S320.452,0,315.733,0H281.6 c-4.719,0-8.533,3.823-8.533,8.533V128c0,4.71,3.814,8.533,8.533,8.533h68.267c4.719,0,8.533-3.823,8.533-8.533V17.067h56.201 l80.333,80.333v371.934c0,14.114-11.486,25.6-25.6,25.6h-42.667V281.6c0-4.71-3.814-8.533-8.533-8.533H93.867 c-4.719,0-8.533,3.823-8.533,8.533v187.733c0,4.71,3.814,8.533,8.533,8.533c4.719,0,8.533-3.823,8.533-8.533v-179.2h307.2 v213.333c0,4.71,3.814,8.533,8.533,8.533h51.2C492.86,512,512,492.86,512,469.333V93.867C512,91.605,511.104,89.429,509.5,87.834 z"
                        ></path>
                        <path
                          d="M179.2,426.667h153.6c4.719,0,8.533-3.823,8.533-8.533s-3.814-8.533-8.533-8.533H179.2c-4.719,0-8.533,3.823-8.533,8.533 S174.481,426.667,179.2,426.667z"
                        ></path>
                        <path
                          d="M179.2,375.467h153.6c4.719,0,8.533-3.823,8.533-8.533s-3.814-8.533-8.533-8.533H179.2c-4.719,0-8.533,3.823-8.533,8.533 S174.481,375.467,179.2,375.467z"
                        ></path>
                      </g>
                    </g>
                  </g>
                </g>
              </svg>
            </span>
            Sačuvaj
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
//AUTOMATIC SCROLL TO HTML TABLE
    window.onload = function() {
        // Delay execution by 500 milliseconds
        setTimeout(function() {
            const element = document.getElementById("target-section");
            if (element) {
                element.scrollIntoView({ 
                    behavior: "smooth", 
                    block: "start" 
                });
            }
        }, 800); 
    };
</script>

{% endblock %}
